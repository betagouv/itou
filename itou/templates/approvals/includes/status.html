{% load i18n %}
{% load static %}
{% load call_method %}
{% comment %}

    Usage:
        {% include "approvals/includes/status.html" with approval=approval %}
        {% include "approvals/includes/status.html" with approval=approval job_application=job_application %}

{% endcomment %}

{% if approval.is_pass_iae %}
    <p class="text-center">
        {% if approval.is_pass_iae and approval.is_suspended %}
            <img src="{% static 'img/pass_iae/logo_pass_iae_suspended.svg' %}" alt="Logo PASS IAE">
            <br>
            <span class="badge badge-warning">{% translate "PASS IAE suspendu" %}</span>
        {% else %}
            <img src="{% static 'img/pass_iae/logo_pass_iae.svg' %}" alt="Logo PASS IAE">
        {% endif %}
    </p>
{% endif %}

<p>
    {% if approval.is_pass_iae %}
        {% translate "Numéro de PASS IAE (agrément) :" %}
    {% else %}
        {% translate "Agrément existant :" %}
    {% endif %}
    <b>{{ approval.number_with_spaces }}</b>
</p>

{% if approval.is_valid %}

    <ul class="list-unstyled pl-2 border-left" style="border-left-width: 3px !important;">

        {# Validity. #}
        <li{% if not approval.is_suspended %} class="text-success"{% endif %}>
            {% blocktranslate with start=approval.start_at|date:"d/m/Y" end=approval.display_end_at|date:"d/m/Y" %}
                Valide du {{ start }} au {{ end }}
            {% endblocktranslate %}
        </li>

        {# Delivery date. #}
        <li>
            {% blocktranslate with start=approval.start_at|date:"d/m/Y" %}
                Délivrance : le {{ start }}
            {% endblocktranslate %}
        </li>

        {# Suspensions history. #}
        {% with approval.suspensions_by_start_date_asc as suspensions %}
            {% if suspensions %}
                {% translate "Suspensions :" %}
                <ul>
                    {% for s in suspensions %}
                        <li>
                            <span{% if s.is_in_progress %} class="text-danger"{% endif %}>
                                {% blocktranslate with start=s.start_at|date:"d/m/Y" end=s.end_at|date:"d/m/Y" %}
                                    du {{ start }} au {{ end }}
                                {% endblocktranslate %}
                            </span>
                            {% if s.is_in_progress %}
                                <small>
                                    <b>{% translate "En cours" %}</b>
                                </small>
                            {% endif %}
                            {% if current_siae %}
                                {% call_method s "can_be_handled_by_siae" current_siae as can_be_handled %}
                                {% if can_be_handled %}
                                    <small>
                                        <a href="{% url 'approvals:suspension_update' suspension_id=s.pk %}?back_url={{ request.get_full_path|urlencode }}">{% translate "Modifier" %}</a>
                                        <a href="{% url 'approvals:suspension_delete' suspension_id=s.pk %}?back_url={{ request.get_full_path|urlencode }}">{% translate "Annuler" %}</a>
                                    </small>
                                {% endif %}
                            {% endif %}
                            <br>
                            <small>{{ s.get_reason_display }}</small>
                        </li>
                    {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}

        {# Prolongations history. #}
        {% with approval.prolongations_by_start_date_asc as prolongations %}
            {% if prolongations %}
                {% translate "Prolongations :" %}
                <ul>
                    {% for p in prolongations %}
                        <li{% if p.is_in_progress %} class="font-weight-bold"{% endif %}>
                            {% blocktranslate with start=p.start_at|date:"d/m/Y" end=p.end_at|date:"d/m/Y" %}
                                du {{ start }} au {{ end }}
                            {% endblocktranslate %}
                            <br>
                            <small>{{ p.get_reason_display }}</small>
                            <br>
                            <small>
                                {% blocktranslate with full_name=p.validated_by.get_full_name|title email=p.validated_by.email %}Autorisation par <i>{{ full_name }}</i> ({{ email }}){% endblocktranslate %}
                            </small>
                        </li>
                    {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}

    </ul>

{% elif approval.is_in_waiting_period %}

    {% if job_application.is_pending and job_application.is_sent_by_authorized_prescriber %}

        {% comment %}
        Display nothing about the status.

        When an authorized prescriber bypasses the waiting period and sends a candidate
        with an "expired" approval, the employer receives the application with the mention
        "expired". He thinks that the hiring is impossible when he just has to validate
        the job application to get a new PASS IAE.

        The mention "expired" is removed if the job application is sent by an authorized
        prescriber and is still waiting to be processed.

        Otherwise the employer could decline the job application thinking that the hiring
        is impossible.
        {% endcomment %}

    {% else %}

        <p class="text-danger">
            {% blocktranslate with end=approval.display_end_at|date:"d/m/Y" since=approval.display_end_at|timesince %}
                <b>Expiré</b> le {{ end }} (depuis {{ since }})
            {% endblocktranslate %}
        </p>

    {% endif %}

{% endif %}
