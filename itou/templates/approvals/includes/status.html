{% load i18n %}
{% load static %}
{% load call_method %}
{% comment %}

    Usage:
        {% include "approvals/includes/status.html" with approval=approval %}
        {% include "approvals/includes/status.html" with approval=approval job_application=job_application %}

{% endcomment %}

{% if approval.is_pass_iae %}
    <p class="text-center">
        {% if approval.is_pass_iae and approval.is_suspended %}
            <img src="{% static 'img/pass_iae/logo_pass_iae_suspended.svg' %}" alt="Logo PASS IAE">
            <br>
            <span class="badge badge-warning">{% translate "PASS IAE suspendu" %}</span>
        {% elif approval.is_pass_iae and approval.has_pending_prolongation %}
            <img src="{% static 'img/pass_iae/logo_pass_iae.svg' %}" alt="Logo PASS IAE">
            <br>
            <span class="badge badge-warning">{% translate "Demande de prolongation à l'étude" %}</span>
        {% else %}
            <img src="{% static 'img/pass_iae/logo_pass_iae.svg' %}" alt="Logo PASS IAE">
        {% endif %}
    </p>
{% endif %}

<p>
    {% if approval.is_pass_iae %}
        {% translate "Numéro de PASS IAE (agrément) :" %}
    {% else %}
        {% translate "Agrément existant :" %}
    {% endif %}
    <b>{{ approval.number_with_spaces }}</b>
</p>

{% if approval.is_valid %}

    <ul class="list-unstyled pl-2 border-left" style="border-left-width: 3px !important;">

        {# Delivery date. #}
        <li>
            {% blocktranslate with start=approval.start_at|date:"d/m/Y" %}
                Délivré le {{ start }}
            {% endblocktranslate %}
        </li>

        {# Validity. #}
        <li{% if not approval.is_suspended %} class="text-success"{% endif %}>
            {% blocktranslate with start=approval.start_at|date:"d/m/Y" end=approval.end_at|date:"d/m/Y" %}
                Valide du {{ start }} au {{ end }}
            {% endblocktranslate %}
        </li>

        {# Suspensions history. #}
        {% with approval.suspensions_by_start_date_asc as suspensions %}
            {% if suspensions %}
                {% translate "Suspendu :" %}
                <ul>
                    {% for s in suspensions %}
                        <li>
                            {% blocktranslate with start=s.start_at|date:"d/m/Y" end=s.end_at|date:"d/m/Y" %}
                                du {{ start }} au {{ end }}
                            {% endblocktranslate %}
                            {% if s.is_in_progress %}
                                <small>
                                    <b>{% translate "En cours" %}</b>
                                </small>
                            {% endif %}
                            {% if current_siae %}
                                {% call_method s "can_be_handled_by_siae" current_siae as can_be_handled %}
                                {% if can_be_handled %}
                                    <small>
                                        <a href="{% url 'approvals:suspension_update' suspension_id=s.pk %}?back_url={{ request.get_full_path|urlencode }}">{% translate "Modifier" %}</a>
                                        <a href="{% url 'approvals:suspension_delete' suspension_id=s.pk %}?back_url={{ request.get_full_path|urlencode }}">{% translate "Annuler" %}</a>
                                    </small>
                                {% endif %}
                            {% endif %}
                            <br>
                            <small>{{ s.get_reason_display }}</small>
                        </li>
                    {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}

        {% with approval.prolongations_by_start_date_asc as prolongations %}
            {% if prolongations %}
                {% translate "Prolongé :" %}
                <ul>
                    {% for p in prolongations %}
                        <li{% if p.is_in_progress %} class="font-weight-bold"{% endif %}>
                            {% blocktranslate with start=p.start_at|date:"d/m/Y" end=p.end_at|date:"d/m/Y" %}
                                du {{ start }} au {{ end }}
                            {% endblocktranslate %}
                            <small>
                                <b>
                                    {% if p.status == p.Status.PENDING %}
                                        {% translate "À l'étude" %}
                                    {% else %}
                                        {{ p.get_status_display }}
                                    {% endif %}
                                </b>
                            </small>
                            <br>
                            <small>{{ p.get_reason_display }}</small>
                        </li>
                    {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}

    </ul>

{% elif approval.is_in_waiting_period %}

    {% comment %}
    Hide the "expired" status when a job application is sent by an authorized prescriber
    for a job seeker with an approval in waiting period. The "expired" status suggests to
    employers that they cannot hire the job seeker. But authorized prescribers can bypass
    approvals in waiting period.
    {% endcomment %}
    {% if not job_application.is_sent_by_authorized_prescriber %}
        <p class="text-danger">
            {% blocktranslate with end=approval.end_at|date:"d/m/Y" since=approval.end_at|timesince %}
                <b>Expiré</b> le {{ end }} (depuis {{ since }})
            {% endblocktranslate %}
        </p>
    {% endif %}

{% endif %}
